<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>RgentAI Assistant</title>
    <style>
      :root {
        /* Default light theme variables - will be overridden by JavaScript */
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-card: #ffffff;
        --text-primary: #2c3e50;
        --text-secondary: #6c757d;
        --border-color: #dee2e6;
        --input-bg: #ffffff;
        --code-bg: #f8f9fa;
        --rgent-primary: #ff6b35; /* Will be overridden by JavaScript for theme awareness */
        --rgent-accent: #3498db; /* Will be overridden by JavaScript for theme awareness */
      }
      
      body { 
        font-family: Arial, sans-serif; 
        margin: 20px; 
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }
      
      /* Tab Navigation */
      .tab-navigation {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        justify-content: flex-end;
      }
      
      .tab-btn {
        padding: 8px 16px;
        background-color: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      
      .tab-btn.active {
        background-color: var(--text-primary);
        color: var(--bg-primary);
        border-color: var(--text-primary);
      }
      
      .tab-btn:hover {
        background-color: var(--text-secondary);
        color: var(--bg-primary);
        border-color: var(--text-secondary);
      }
      
      .tab-content {
        display: none;
      }
      
      .tab-content.active {
        display: block;
      }
      
      .chat-container { 
        height: 60vh; 
        min-height: 250px;
        max-height: 70vh;
        overflow-y: auto; 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        padding: 15px; 
        margin-bottom: 15px; 
        background-color: var(--bg-card); 
        transition: all 0.3s ease;
      }
      .message { 
        margin-bottom: 10px; 
        padding: 8px 12px; 
        border-radius: 8px; 
        max-width: 80%; 
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        transition: all 0.3s ease;
      }
      .user-message { 
        background-color: var(--text-primary); 
        color: var(--bg-primary); 
        margin-left: auto; 
        margin-right: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .ai-message { 
        background-color: var(--bg-card); 
        color: var(--text-primary); 
        line-height: 1.5;
        word-wrap: break-word;
        word-break: normal;
        overflow-wrap: break-word;
        hyphens: none;
        white-space: normal;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .ai-message strong {
        font-weight: bold;
      }
      
      .ai-message em {
        font-style: italic;
      }
      
      .ai-message code {
        background-color: var(--code-bg);
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
      }
      
      .debug-button {
        background-color: #dc3545 !important;
        color: white !important;
        border: none !important;
        padding: 8px 12px !important;
        border-radius: 4px !important;
        cursor: pointer !important;
      }
      
      .analyze-button {
        background-color: #805ad5 !important;
        color: white !important;
        border: none !important;
        padding: 8px 12px !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
      }
      
      .analyze-button:hover {
        background-color: #6b46c1 !important;
      }
      
      .access-button {
        background-color: #8e44ad !important;
        color: white !important;
        border: none !important;
        padding: 8px 16px !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
      }
      
      .access-button:hover {
        background-color: #7d3c98 !important;
      }
      
      .send-button {
        background-color: #27ae60 !important;
        color: white !important;
        border: none !important;
        padding: 8px 16px !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
      }
      
      .send-button:hover {
        background-color: #229954 !important;
      }
      
      /* Prevent breaking of common terms */
      .ai-message {
        word-break: normal !important;
        hyphens: none !important;
      }
      
      /* Specific protection for function names and data frame names */
      .ai-message div {
        word-break: normal !important;
        hyphens: none !important;
      }
      .code-block { 
        background-color: var(--code-bg); 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        padding: 15px; 
        margin: 15px 0; 
        font-family: 'Courier New', monospace;
        white-space: pre;
        overflow-x: auto;
        overflow-y: hidden;
        color: var(--text-primary);
        position: relative;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        max-width: 100%;
      }
      
      .code-block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--bg-secondary);
        margin: -15px -15px 10px -15px;
        padding: 8px 15px;
        border-radius: 8px 8px 0 0;
        color: var(--text-primary);
        font-size: 12px;
        font-weight: bold;
        width: 100%;
      }
      .code-block-actions {
        margin-left: auto;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      
      .copy-button {
        background-color: #38a169;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        transition: background-color 0.2s;
      }
      
      .copy-button:hover {
        background-color: #2f855a;
      }
      
      .copy-button:active {
        background-color: #276749;
      }
      
      .copy-button.copied {
        background-color: #3182ce;
      }
      .insert-button { 
        background-color: #28a745; 
        color: white; 
        border: none; 
        padding: 5px 10px; 
        border-radius: 4px; 
        cursor: pointer; 
        margin: 5px; 
      }
      .insert-button:hover { 
        background-color: #218838; 
      }
      .input-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .input-row {
        display: flex;
        gap: 10px;
      }
      
      .button-row {
        display: flex;
        gap: 10px;
      }
      
      .button-row button {
        flex: 1;
      }
      input[type="text"] { 
        flex: 1;
        padding: 8px; 
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-primary);
      }
      button { 
        padding: 8px 16px; 
        background-color: var(--rgent-primary); 
        color: white; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        transition: all 0.3s ease;
      }
      button:hover {
        background-color: var(--rgent-accent);
      }

      
      /* Usage Tab Styles */
      .usage-container {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        color: var(--text-primary);
      }
      
      .stats-section {
        margin-bottom: 30px;
      }
      
      .stats-section h4 {
        margin-bottom: 15px;
        color: var(--text-primary);
        font-size: 16px;
      }
      
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      
      /* Plan Type Box - Horizontal Prominent Display */
      .plan-type-box {
        background: var(--bg-card);
        border: 2px solid var(--rgent-accent);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
        color: var(--text-primary);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .plan-type-header {
        margin-bottom: 10px;
      }
      
      .plan-type-header h3 {
        margin: 0 0 5px 0;
        font-size: 18px;
        font-weight: bold;
        color: var(--text-primary);
      }
      
      .plan-type-header small {
        color: var(--text-secondary);
        font-size: 12px;
      }
      
      .plan-type-display {
        font-size: 32px;
        font-weight: bold;
        color: var(--rgent-accent);
      }
      
      /* Subscription Info Box */
      .subscription-info-box {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        color: var(--text-primary);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .subscription-header {
        margin-bottom: 15px;
      }
      
      .subscription-header h3 {
        margin: 0 0 5px 0;
        font-size: 18px;
        font-weight: bold;
        color: var(--text-primary);
      }
      
      .subscription-header small {
        color: var(--text-secondary);
        font-size: 12px;
      }
      
      .subscription-details {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .subscription-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
      }
      
      .subscription-item:last-child {
        border-bottom: none;
      }
      
      .subscription-label {
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 14px;
      }
      
      .subscription-value {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 14px;
        text-align: right;
      }
      
      /* Total Cost Box - Horizontal Prominent Display */
      .total-cost-box {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
        color: var(--text-primary);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .total-cost-header {
        margin-bottom: 10px;
      }
      
      .total-cost-header h3 {
        margin: 0 0 5px 0;
        font-size: 18px;
        font-weight: bold;
        color: var(--text-primary);
      }
      
      .total-cost-header small {
        color: var(--text-secondary);
        font-size: 12px;
      }
      
      .total-cost-amount {
        font-size: 32px;
        font-weight: bold;
        color: var(--text-primary);
      }
      
      /* Input Output Container - Side by Side */
      .input-output-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      
      .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .stat-card h4 {
        margin-bottom: 10px;
        color: var(--text-primary);
        font-size: 14px;
      }
      
      .stat-card div {
        font-size: 24px;
        font-weight: bold;
        color: var(--text-primary);
        margin-bottom: 5px;
      }
      
      .stat-card small {
        color: var(--text-secondary);
        font-size: 12px;
      }
      
      /* Progress Bar */
      .progress-fill {
        background: linear-gradient(90deg, var(--rgent-accent), var(--rgent-accent-dark));
        height: 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 12px;
        transition: width 0.3s ease;
      }
      
      #monthly-progress-bar, #free-progress-bar {
        background: var(--bg-secondary);
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        border: 1px solid var(--border-color);
      }
      
      .access-section {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        text-align: center;
        color: var(--text-primary);
      }
      
      .form-group {
        margin-bottom: 15px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: var(--text-primary);
        font-weight: bold;
      }
      
      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        background-color: var(--input-bg);
        color: var(--text-primary);
      }
      
      .access-help {
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-secondary);
      }
      
      .access-help a {
        color: var(--rgent-accent);
        text-decoration: none;
      }
      
      .access-help a:hover {
        text-decoration: underline;
      }
      
      /* Guide Tab Styles */
      .guide-container {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        color: var(--text-primary);
      }
      
      .guide-section {
        margin-bottom: 30px;
      }
      
      .guide-section h3 {
        margin-bottom: 15px;
        color: var(--text-primary);
        font-size: 18px;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 8px;
      }
      
      .guide-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .guide-card h4 {
        margin-bottom: 10px;
        color: var(--text-primary);
        font-size: 16px;
        font-weight: bold;
      }
      
      .guide-card p {
        margin-bottom: 10px;
        line-height: 1.5;
        color: var(--text-secondary);
      }
      
      .guide-card ul {
        margin: 10px 0;
        padding-left: 20px;
      }
      
      .guide-card li {
        margin-bottom: 5px;
        line-height: 1.4;
        color: var(--text-secondary);
      }
      
      .guide-card code {
        background-color: var(--code-bg);
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
        color: var(--text-primary);
      }
      
      /* Progress bar for free trial */
      #free-progress-bar {
        width: 100%;
        height: 20px;
        background-color: var(--bg-secondary);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--border-color);
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--rgent-primary), var(--rgent-accent));
        border-radius: 10px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      }
    </style>
</head>
<body>
            <h3>Rgent - Your RStudio AI Assistant</h3>
    
    <!-- Access Code Section -->
    <div id="access-section" class="access-section">
      <div class="form-group">
        <label for="access-code">Access Code:</label>
        <div style="position: relative; display: flex; align-items: center;">
          <input type="password" id="access-code" placeholder="Enter your access code" style="flex: 1; margin-right: 10px;">
          <button type="button" id="toggleAccessCode" style="background: none; border: none; cursor: pointer; color: #925de8; font-size: 12px; padding: 8px 12px; font-weight: 500; text-decoration: underline; white-space: nowrap;">
            Show
          </button>
        </div>
      </div>
                <button onclick="validateAccess()" class="access-button">Validate Access</button>
      <div id="access-status"></div>
      <div class="access-help">
        <p>Forgot your access code? <a href="https://rgentai.com/signin.html" target="_blank">Click here</a></p>
      </div>
    </div>
    
    <!-- Main Interface with Tabs -->
    <div id="main-interface" style="display: none;">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('chat')">&#128172; Chat</button>
        <button class="tab-btn" onclick="switchTab('usage')">&#128202; Usage</button>
        <button class="tab-btn" onclick="switchTab('guide')">üìñ Guide</button>
        <button class="tab-btn" onclick="newConversation()" id="new-conversation-button" disabled>üîÑ New Conversation</button>
      </div>
      
      <!-- Chat Tab -->
      <div id="chat-tab" class="tab-content active">
        <div id="chat-container" class="chat-container">
          <div class="message ai-message">Connecting to RStudio...</div>
        </div>
        <div class="input-container">
          <div class="input-row">
            <input type="text" id="user-input" placeholder="Type your question here..." disabled>
            <button onclick="sendMessage()" id="send-button" disabled class="send-button">Send</button>
          </div>
          <div class="button-row">
            <button onclick="debugLastError()" id="debug-error-button" disabled class="debug-button">&#128027; Debug Last Error</button>
            <button onclick="analyzeLastPlot()" id="analyze-plot-button" disabled class="analyze-button">üìä Analyze Last Plot</button>
          </div>
        </div>

      </div>
      
      <!-- Usage Tab -->
      <div id="usage-tab" class="tab-content">
        <div class="usage-container">
          <div class="section">
            <h3>üìä Usage Statistics</h3>
            
            <!-- Overall Stats -->
            <div class="stats-section" id="paid-usage-section">
              
              <!-- Plan Type Display -->
              <div class="plan-type-box">
                <div class="plan-type-header">
                  <h3>Current Plan</h3>
                  <small>Your subscription</small>
                </div>
                <div class="plan-type-display" id="plan-type-display">-</div>
              </div>
              
              <!-- Subscription Info -->
              <div class="subscription-info-box">
                <div class="subscription-header">
                  <h3>Subscription Details</h3>
                  <small>Billing information</small>
                </div>
                <div class="subscription-details">
                  <div class="subscription-item">
                    <span class="subscription-label">Status:</span>
                    <span class="subscription-value" id="subscription-status">-</span>
                  </div>
                  <div class="subscription-item">
                    <span class="subscription-label">Next Billing:</span>
                    <span class="subscription-value" id="subscription-end-date">-</span>
                  </div>

                </div>
              </div>

            </div>



            <!-- Monthly Usage -->
            <div class="stats-section" id="monthly-usage-section">
              <h4>Monthly Usage</h4>
              
              <!-- Monthly Requests -->
              <div class="stat-card">
                <h4>Monthly Requests</h4>
                <div id="monthly-requests">-</div>
                <small id="monthly-requests-limit">-</small>
              </div>
              
              <!-- Requests Remaining -->
              <div class="stat-card">
                <h4>Requests Remaining</h4>
                <div id="requests-remaining">-</div>
                <small>This month</small>
              </div>
              
              <!-- Progress Bar -->
              <div class="stat-card">
                <h4>Progress</h4>
                <div id="monthly-progress-bar">
                  <div class="progress-fill" id="monthly-progress-fill"></div>
                </div>
                <small>Monthly usage progress</small>
              </div>
            </div>

            <!-- Free Trial Stats -->
            <div class="stats-section" id="free-trial-section" style="display: none;">
              <h4>üéÅ Free Trial Usage</h4>
              <div class="stats">
                <div class="stat-card">
                  <h4>Requests Used</h4>
                  <div id="free-requests-used">-</div>
                  <small>Out of 25 free requests</small>
                </div>
                <div class="stat-card">
                  <h4>Requests Remaining</h4>
                  <div id="free-requests-remaining">-</div>
                  <small>Free trial requests left</small>
                </div>
                <div class="stat-card">
                  <h4>Progress</h4>
                  <div id="free-progress-bar">
                    <div class="progress-fill" id="free-progress-fill"></div>
                  </div>
                  <small>Free trial progress</small>
                </div>
              </div>
            </div>

            <div id="usage-status" class="status" style="display: none;"></div>
          </div>
        </div>
      </div>
      
      <!-- Guide Tab -->
      <div id="guide-tab" class="tab-content">
        <div class="guide-container">
          <div class="guide-section">
            <h3>üöÄ Getting Started</h3>
            <div class="guide-card">
              <h4>Be Specific</h4>
              <ul>
                <li>‚úÖ "Create a function to calculate mean by group"</li>
                <li>‚ùå "help me with data"</li>
                <li>‚úÖ "Debug this ggplot error: object not found"</li>
                <li>‚ùå "it's not working"</li>
              </ul>
            </div>
          </div>
          
          <div class="guide-section">
            <h3>üîß Key Features</h3>
            <div class="guide-card">
              <h4>Smart Context Capture</h4>
              <p>Automatically captures your entire R environment - data frames, functions, variables, plots, and active code.</p>
            </div>
            <div class="guide-card">
              <h4>Real-time Streaming</h4>
              <p>Watch AI responses stream in real-time. No waiting for complete responses.</p>
            </div>
            <div class="guide-card">
              <h4>Code Insertion</h4>
              <p>Click "Insert at Cursor" to add code directly into your R scripts. No copy-paste needed.</p>
            </div>
            <div class="guide-card">
              <h4>Error Debugging</h4>
              <p>Click "Debug Last Error" for instant analysis and step-by-step fixes.</p>
            </div>
            <div class="guide-card">
              <h4>Plot Analysis</h4>
              <p>Click "Analyze Last Plot" for statistical insights and improvement suggestions.</p>
            </div>
          </div>
          
          <div class="guide-section">
            <h3>‚ö° Performance Tips</h3>
            <div class="guide-card">
              <h4>Keep Environment Clean</h4>
              <p>This will save tokens and cost:</p>
              <ul>
                <li>Remove unused variables: <code>rm(unused_var)</code></li>
                <li>Clear large objects: <code>rm(large_dataframe)</code></li>
                <li>Restart R session: "Session > Restart R"</li>
                <li>Use <code>rm(list = ls())</code> for fresh start</li>
              </ul>
            </div>
          </div>
          

          
          <div class="guide-section">
            <h3>üîç Troubleshooting</h3>
            <div class="guide-card">
              <h4>Slow Responses?</h4>
              <ul>
                <li>Your environment might be too large</li>
                <li>Try <code>rm(list = ls())</code> to clear workspace</li>
                <li>Restart R session for fresh start</li>
              </ul>
            </div>
            <div class="guide-card">
              <h4>Connection Issues?</h4>
              <ul>
                <li>Check your internet connection</li>
                <li>Verify your access code is valid</li>
                <li>Try refreshing the page</li>
                <li>Restart the addin if needed</li>
              </ul>
            </div>
            <div class="guide-card">
              <h4>Need Anything?</h4>
              <p>Contact us at <a href="mailto:founders@rgentai.com">founders@rgentai.com</a></p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      let ws = null;
      let isConnected = false;
      let isAccessValid = false;
      let accessCode = '';
      let currentStreamingMessage = null;
      let streamingTimeout = null;
      
      // Access validation
      async function validateAccess() {
        const code = document.getElementById('access-code').value.trim();
        if (!code) {
          showAccessStatus('Please enter an access code', 'error');
          return;
        }
        
        showAccessStatus('Validating access...', 'info');
        
        try {
          const response = await fetch('https://rgent.onrender.com/validate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ access_code: code })
          });
          
          const data = await response.json();
          
          if (response.ok && data.valid) {
            isAccessValid = true;
            accessCode = code;
            showAccessStatus('Access validated successfully!', 'success');
            document.getElementById('access-section').style.display = 'none';
            document.getElementById('main-interface').style.display = 'block';
            connectWebSocket();
            
            // Send access code to R backend once WebSocket is connected
            setTimeout(() => {
              if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                  action: 'set_access_code',
                  access_code: code
                }));
              }
            }, 1000);
          } else {
            // Show the specific error message from the backend
            const errorMessage = data.detail || 'Invalid access code';
            showAccessStatus(errorMessage, 'error');
          }
        } catch (error) {
          console.error('Validation error:', error);
          showAccessStatus('Failed to validate access code', 'error');
        }
      }
      
      function showAccessStatus(message, type) {
        const statusDiv = document.getElementById('access-status');
        statusDiv.textContent = message;
        statusDiv.className = 'status ' + type;
        statusDiv.style.display = 'block';
      }
      
      // Tab switching
      function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName + '-tab').classList.add('active');
        
        // Add active class to clicked button
        event.target.classList.add('active');
        
        // Load stats if switching to usage tab
        if (tabName === 'usage') {
          loadStats();
        }
      }
      
      // Load usage statistics
      async function loadStats() {
        if (!isAccessValid) return;

        try {
          const response = await fetch(`https://rgent.onrender.com/usage?access_code=${accessCode}`);
          const data = await response.json();

          console.log('Stats response:', data);

          if (response.ok) {
            // Get plan type and basic stats
            const planType = data.plan_type || 'free_trial';
            const monthRequests = data.month_requests || 0;
            const requestsRemaining = data.requests_remaining || 0;
            
            // Get subscription information
            const subscriptionStatus = data.subscription_status || 'inactive';
            const subscriptionEndDate = data.subscription_end_date || null;
            const subscriptionId = data.subscription_id || null;
            
            console.log('Usage stats:', { 
              planType, monthRequests, requestsRemaining, subscriptionStatus, subscriptionEndDate, subscriptionId
            });
            
            // Update plan type display
            const planTypeDisplay = document.getElementById('plan-type-display');
            if (planTypeDisplay) {
              const planNames = {
                'free_trial': 'üéÅ Free Trial',
                'pro_haiku': 'üöÄ Pro Haiku',
                'pro_sonnet': 'üöÄ Pro Sonnet'
              };
              planTypeDisplay.textContent = planNames[planType] || planType;
            }
            
            // Update subscription information
            const subscriptionStatusElement = document.getElementById('subscription-status');
            const subscriptionEndDateElement = document.getElementById('subscription-end-date');
            const subscriptionIdElement = document.getElementById('subscription-id');
            
            if (subscriptionStatusElement) {
              const statusDisplay = subscriptionStatus === 'active' ? '‚úÖ Active' : '‚ùå Inactive';
              subscriptionStatusElement.textContent = statusDisplay;
            }
            
            if (subscriptionEndDateElement) {
              if (subscriptionEndDate) {
                const endDate = new Date(subscriptionEndDate);
                const formattedDate = endDate.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
                subscriptionEndDateElement.textContent = `${formattedDate} UTC`;
              } else {
                subscriptionEndDateElement.textContent = 'N/A';
              }
            }
            

            

            

            
            // Update monthly usage
            const monthlyRequestsElement = document.getElementById('monthly-requests');
            const monthlyRequestsLimitElement = document.getElementById('monthly-requests-limit');
            const requestsRemainingElement = document.getElementById('requests-remaining');
            const monthlyProgressBar = document.getElementById('monthly-progress-bar');
            const monthlyProgressFill = document.getElementById('monthly-progress-fill');
            
            if (monthlyRequestsElement && monthlyRequestsLimitElement && requestsRemainingElement && monthlyProgressBar && monthlyProgressFill) {
              monthlyRequestsElement.textContent = monthRequests;
              
              // Set limit based on plan type
              let monthlyLimit;
              if (planType === 'free_trial') {
                monthlyLimit = 25;
              } else if (planType === 'pro_haiku' || planType === 'pro_sonnet') {
                monthlyLimit = 500;
              } else {
                monthlyLimit = 100; // fallback
              }
              
              monthlyRequestsLimitElement.textContent = `of ${monthlyLimit} requests`;
              requestsRemainingElement.textContent = requestsRemaining;
              
              // Update progress bar
              const progressPercent = Math.min(100, (monthRequests / monthlyLimit) * 100);
              monthlyProgressFill.style.width = `${progressPercent}%`;
              monthlyProgressFill.textContent = `${Math.round(progressPercent)}%`;
            }
            
            // Show/hide sections based on plan type
            const isFreeTrial = planType === 'free_trial';
            const paidUsageSection = document.getElementById('paid-usage-section');

            const monthlyUsageSection = document.getElementById('monthly-usage-section');
            const freeTrialSection = document.getElementById('free-trial-section');
            
            if (isFreeTrial) {
              // Hide paid usage sections, show free trial section
              paidUsageSection.style.display = 'none';

              monthlyUsageSection.style.display = 'none';
              freeTrialSection.style.display = 'block';
              
              // Update free trial stats
              const requestsUsed = data.monthly_requests || 0;
              const requestsRemaining = Math.max(0, 25 - requestsUsed);
              const progressPercent = Math.min(100, (requestsUsed / 25) * 100);
              
              document.getElementById('free-requests-used').textContent = requestsUsed;
              document.getElementById('free-requests-remaining').textContent = requestsRemaining;
              document.getElementById('free-progress-fill').style.width = `${progressPercent}%`;
              document.getElementById('free-progress-fill').textContent = `${Math.round(progressPercent)}%`;
            } else {
              // Show paid usage sections, hide free trial section
              paidUsageSection.style.display = 'block';

              monthlyUsageSection.style.display = 'block';
              freeTrialSection.style.display = 'none';
              



            }
            
            // Show success status
            const statusDiv = document.getElementById('usage-status');
            statusDiv.className = 'status success';
            statusDiv.textContent = 'Stats updated successfully';
            statusDiv.style.display = 'block';
            setTimeout(() => {
              statusDiv.style.display = 'none';
            }, 3000);
          }
        } catch (error) {
          console.error('Failed to load stats:', error);
          const statusDiv = document.getElementById('usage-status');
          statusDiv.className = 'status error';
          statusDiv.textContent = 'Failed to load stats';
          statusDiv.style.display = 'block';
        }
      }
      
      // Copy code to clipboard with fallback for restricted environments
      function copyToClipboard(text, button) {
        // Check if we're in a restricted environment (like RStudio viewer pane)
        const isRestricted = window.location.href.includes('viewer_pane') || 
                           window.location.href.includes('capabilities') ||
                           !navigator.clipboard;
        
        if (!isRestricted && navigator.clipboard && navigator.clipboard.writeText) {
          // Try modern clipboard API only in non-restricted environments
          navigator.clipboard.writeText(text).then(function() {
            button.textContent = "Copied!";
            button.classList.add("copied");
            setTimeout(function() {
              button.textContent = "Copy";
              button.classList.remove("copied");
            }, 2000);
          }).catch(function(err) {
            console.error('Failed to copy: ', err);
            // Fallback to old method
            fallbackCopyToClipboard(text, button);
          });
        } else {
          // Use fallback method for restricted environments
          fallbackCopyToClipboard(text, button);
        }
      }
      
      function fallbackCopyToClipboard(text, button) {
        // Create a temporary textarea element
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        textArea.style.opacity = "0";
        document.body.appendChild(textArea);
        
        // Select and copy
        textArea.focus();
        textArea.select();
        
        try {
          const successful = document.execCommand('copy');
          if (successful) {
            button.textContent = "Copied!";
            button.classList.add("copied");
            setTimeout(function() {
              button.textContent = "Copy";
              button.classList.remove("copied");
            }, 2000);
          } else {
            button.textContent = "Failed";
            setTimeout(function() {
              button.textContent = "Copy";
            }, 2000);
          }
        } catch (err) {
          console.error('Fallback copy failed: ', err);
          button.textContent = "Failed";
          setTimeout(function() {
            button.textContent = "Copy";
          }, 2000);
        }
        
        // Clean up
        document.body.removeChild(textArea);
      }
      
               // Connect to WebSocket
         function connectWebSocket() {
           // Try port 8888 first, then 8889 if that fails
           let wsUrl;
           
           if (window.location.protocol === 'https:') {
             // If we're on HTTPS, use secure WebSocket
             const host = window.location.hostname || 'localhost';
             wsUrl = `wss://${host}/ws`;
           } else {
             // If we're on HTTP, use regular WebSocket
             const host = window.location.hostname || '127.0.0.1';
             wsUrl = `ws://${host}:8888`;
           }
           
           console.log("Connecting to WebSocket:", wsUrl);
           ws = new WebSocket(wsUrl);
           
           ws.onerror = function(event) {
             console.log("WebSocket connection failed on port 8888, trying 8889...");
             // Try port 8889 if 8888 fails
             wsUrl = `ws://${window.location.hostname || '127.0.0.1'}:8889`;
             console.log("Connecting to WebSocket:", wsUrl);
             ws = new WebSocket(wsUrl);
             
             ws.onopen = function() {
               console.log("WebSocket connected on port 8889");
               isConnected = true;
               document.getElementById("user-input").disabled = false;
               document.getElementById("send-button").disabled = false;
               document.getElementById("new-conversation-button").disabled = false;
               document.getElementById("debug-error-button").disabled = false;
               document.getElementById("analyze-plot-button").disabled = false;
               addMessage("Connected! Ask me anything about your R code.", "ai");
             };
             
             ws.onmessage = function(event) {
               console.log("Message received:", event.data);
               handleMessage(event.data);
             };
             
             ws.onclose = function() {
               console.log("WebSocket disconnected");
               isConnected = false;
               document.getElementById("user-input").disabled = true;
               document.getElementById("send-button").disabled = true;
               document.getElementById("new-conversation-button").disabled = true;
               document.getElementById("debug-error-button").disabled = true;
               document.getElementById("analyze-plot-button").disabled = true;
             };
             
             ws.onerror = function(event) {
               console.log("WebSocket error on port 8889:", event);
             };
           };
        
        ws.onopen = function() {
          console.log("WebSocket connected");
          isConnected = true;
          document.getElementById("user-input").disabled = false;
          document.getElementById("send-button").disabled = false;
          document.getElementById("new-conversation-button").disabled = false;
          document.getElementById("debug-error-button").disabled = false;
          document.getElementById("analyze-plot-button").disabled = false;
          addMessage("Connected! Ask me anything about your R code.", "ai");
        };
        
        ws.onmessage = function(event) {
          const data = JSON.parse(event.data);
          console.log("Received:", data);
          
          switch(data.action) {
            case "ai_response":
              if (data.streaming) {
                // Handle streaming response
                if (data.chunk) {
                  addStreamingChunk(data.chunk);
                } else if (data.finished) {
                  finishStreaming();
                }
              } else {
                // Handle regular response
                addMessage(data.message, "ai");
              }
              break;
            case "inserted":
              addMessage("Code inserted successfully!", "ai");
              break;
            case "executed":
              if (data.status === "success") {
                addMessage("Code executed successfully! Output: " + (data.output || "No output"), "ai");
              } else {
                addMessage("Code execution failed: " + data.error, "ai");
              }
              break;
            case "execute_and_fix":
              if (data.status === "success") {
                addMessage("Code executed successfully! Output: " + (data.output || "No output"), "ai");
              } else if (data.status === "error_fixed") {
                addMessage("Code failed but AI provided a fix:\n\nOriginal error: " + data.original_error + "\n\nFixed code:\n```r\n" + data.fixed_code + "\n```", "ai");
              } else {
                addMessage("Code execution failed: " + data.error, "ai");
              }
              break;
            case "error":
              addMessage("Error: " + data.message, "ai");
              break;
            case "get_last_error":
              if (data.message) {
                addMessage(data.message, "ai");
              }
              break;
            case "debug_info":
              // Skip the verbose progress updates - just show the AI fix directly
              break;
            case "debug_ai_response":
              if (data.streaming) {
                addStreamingChunk(data.chunk);
              } else {
                console.log("DEBUG: Finishing debug streaming");
                finishStreaming();
                // No buttons - just show the debug analysis
              }
              break;
            case "chat_with_ai":
              // Handle messages sent to the chat interface
              if (data.message) {
                addMessage(data.message, "ai");
              }
              break;
            case "plot_analysis":
              if (data.success) {
                // Process plot analysis response properly
                const fullMessage = "‚úÖ **Plot Analysis Complete!**\n\n" + data.ai_interpretation;
                addPlotAnalysisMessage(fullMessage);
              } else {
                addMessage("‚ùå **Plot Analysis Failed:** " + data.message, "ai");
              }
              break;

            case "theme_info":
              // Apply RStudio theme with actual colors
              if (data.is_dark !== undefined) {
                applyTheme(data.is_dark, data.theme_name, data.colors);
              }
              break;

          }
        };
        
        ws.onclose = function() {
          console.log("WebSocket disconnected");
          isConnected = false;
          document.getElementById("user-input").disabled = true;
          document.getElementById("send-button").disabled = true;
          document.getElementById("debug-error-button").disabled = true;
          addMessage("Connection lost. Please restart the addin.", "ai");
        };
        
        ws.onerror = function(error) {
          console.error("WebSocket error:", error);
          addMessage("Failed to connect to RStudio. Please check if the server is running.", "ai");
        };
      }
      
      function debugLastError() {
        if (!isConnected) return;
        
        console.log("Requesting last error...");
        const message = {
          action: "get_last_error"
        };
        
        ws.send(JSON.stringify(message));
      }
      
      function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value.trim();
        if (!message || !isConnected) return;
        
        // Add user message
        addMessage(message, "user");
        input.value = "";
        
        // Insert AI placeholder while thinking
        const thinking = document.createElement("div");
        thinking.className = "message ai-message";
        thinking.id = "ai-thinking";
        thinking.textContent = "Thinking...";
        document.getElementById("chat-container").appendChild(thinking);
        
        // Send to R via WebSocket
        ws.send(JSON.stringify({
          action: "chat_with_ai",
          message: message
        }));
      }
      
      function addStreamingChunk(chunk) {
        if (!currentStreamingMessage) {
          // Remove thinking placeholder if present
          const placeholder = document.getElementById("ai-thinking");
          if (placeholder && placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
          
          // Start new streaming message
          currentStreamingMessage = document.createElement("div");
          currentStreamingMessage.className = "message ai-message";
          currentStreamingMessage.innerHTML = "";
          document.getElementById("chat-container").appendChild(currentStreamingMessage);
        }
        
        // Add chunk to current message
        currentStreamingMessage.innerHTML += chunk;
        
        // Don't apply any formatting during streaming - wait until complete
        // This prevents breaking lines in the middle of words
        
        // Scroll to bottom
        const container = document.getElementById("chat-container");
        container.scrollTop = container.scrollHeight;
        
        // Clear any existing timeout
        if (streamingTimeout) {
          clearTimeout(streamingTimeout);
        }
        
        // Set timeout to finish streaming if no more chunks
        streamingTimeout = setTimeout(() => {
          finishStreaming();
        }, 1000);
      }
      
      function applyBasicFormatting(messageDiv) {
        let content = messageDiv.innerHTML;
        
        // Only apply basic formatting during streaming (no code blocks)
        // Bold text
        content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Italic text
        content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        // Numbered lists
        content = content.replace(/^(\d+\.\s+)(.*)$/gm, '<div style="margin-left: 20px; white-space: normal; word-wrap: break-word; word-break: normal; hyphens: none;"><strong>$1</strong>$2</div>');
        
        // Bullet points
        content = content.replace(/^[-*]\s+(.*)$/gm, '<div style="margin-left: 20px; white-space: normal; word-wrap: break-word; word-break: normal; hyphens: none;">‚Ä¢ $1</div>');
        
        messageDiv.innerHTML = content;
      }
      
      function processMarkdownFormatting(messageDiv) {
        let content = messageDiv.innerHTML;
        
        // Process markdown formatting
        // Bold text
        content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Italic text
        content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        // Numbered lists
        content = content.replace(/^(\d+\.\s+)(.*)$/gm, '<div style="margin-left: 20px; white-space: normal; word-wrap: break-word; word-break: normal; hyphens: none;"><strong>$1</strong>$2</div>');
        
        // Bullet points
        content = content.replace(/^[-*]\s+(.*)$/gm, '<div style="margin-left: 20px; white-space: normal; word-wrap: break-word; word-break: normal; hyphens: none;">‚Ä¢ $1</div>');
        
        // Inline code (but not code blocks) - only single backticks
        // Make sure we don't match triple backticks (```)
        content = content.replace(/(?<!`)`([^`]+)`(?!`)/g, '<code style="background-color: var(--code-bg); padding: 2px 4px; border-radius: 3px;">$1</code>');
        
        messageDiv.innerHTML = content;
      }
      
      function finishStreaming() {
        console.log("DEBUG: finishStreaming called");
        if (currentStreamingMessage) {
          console.log("DEBUG: Processing final message for formatting");
          
          // Check if this is a plot analysis message (has plot analysis content)
          const content = currentStreamingMessage.innerHTML;
          const isPlotAnalysis = content.includes("plot") || content.includes("histogram") || 
                                content.includes("scatter") || content.includes("boxplot") ||
                                content.includes("density") || content.includes("violin") ||
                                content.includes("correlation") || content.includes("outlier");
          
          if (isPlotAnalysis) {
            // Use plot analysis specific processing (no Execute & Fix button)
            processPlotAnalysisContent(currentStreamingMessage);
          } else {
            // Use regular processing for code blocks and buttons
            processMessageContent(currentStreamingMessage);
          }
          
          currentStreamingMessage = null;
        }
        if (streamingTimeout) {
          clearTimeout(streamingTimeout);
          streamingTimeout = null;
        }
      }
      
      // Dynamic resize function for chat container
      function resizeChatContainer() {
        const chatContainer = document.getElementById("chat-container");
        if (chatContainer) {
          const viewportHeight = window.innerHeight;
          const availableHeight = viewportHeight - 250; // Account for header, input, margins
          chatContainer.style.height = Math.max(250, Math.min(availableHeight, viewportHeight * 0.6)) + "px";
        }
      }
      
      // Add resize listener
      window.addEventListener('resize', resizeChatContainer);
      
      // Initial resize
      document.addEventListener('DOMContentLoaded', resizeChatContainer);
      

      
      function processMessageContent(messageDiv) {
        const content = messageDiv.innerHTML;
        
        console.log("DEBUG: Processing content for code blocks:", content.substring(0, 200) + "...");
        
        // More precise code block detection - only create blocks for actual code blocks, not inline code
        const hasMarkdownCodeBlock = /```[rR]\n[\s\S]*?```/.test(content) || /```[rR][\s\S]*?```/.test(content) || /```R\n[\s\S]*?```/.test(content) || /```R[\s\S]*?```/.test(content);
        
        console.log("DEBUG: hasMarkdownCodeBlock:", hasMarkdownCodeBlock);
        // Only detect HTML code blocks that are actual blocks, not inline code
        const hasHTMLCodeBlock = /<code[^>]*>[\s\S]*?<\/code>/.test(content) && 
                                !content.includes('<code style="background-color: var(--code-bg); padding: 2px 4px; border-radius: 3px;">');
        
        if (hasMarkdownCodeBlock || hasHTMLCodeBlock) {
          // Clear the message div
          messageDiv.innerHTML = "";
          
          // Try to split by markdown code blocks first
          let parts = content.split(/(```[rR]\n[\s\S]*?```)/g);
          
          // If no markdown blocks found, try HTML code blocks
          if (parts.length === 1) {
            parts = content.split(/(<code[^>]*>[\s\S]*?<\/code>)/g);
          }
          
          for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            
            if ((part.startsWith("```r\n") && part.endsWith("```")) || 
                (part.startsWith("```R\n") && part.endsWith("```")) ||
                (part.includes("<code") && part.includes("</code>"))) {
              // This is a code block - style it
              const codeDiv = document.createElement("div");
              codeDiv.className = "code-block";
              
              // Create header with copy button
              const headerDiv = document.createElement("div");
              headerDiv.className = "code-block-header";
              
              const languageLabel = document.createElement("span");
              languageLabel.textContent = "R Code";
              
              const actionsDiv = document.createElement("div");
              actionsDiv.className = "code-block-actions";
              
              const copyButton = document.createElement("button");
              copyButton.className = "copy-button";
              copyButton.textContent = "Copy";
              copyButton.onclick = function() {
                // Use the cleaned code for copying, not the original HTML
                copyToClipboard(cleanCode, copyButton);
              };
              
              const insertButton = document.createElement("button");
              insertButton.className = "copy-button";
              insertButton.textContent = "Insert at Cursor";
              insertButton.onclick = function() {
                insertCode(cleanCode);
              };
              
              headerDiv.appendChild(languageLabel);
              actionsDiv.appendChild(copyButton);
              actionsDiv.appendChild(insertButton);
              headerDiv.appendChild(actionsDiv);
              codeDiv.appendChild(headerDiv);
              
              // Create code content div - extract just the code
              const codeContent = document.createElement("div");
              let cleanCode;
              if (part.startsWith("```r\n")) {
                // Markdown format - remove ```r\n at start and ``` at end
                cleanCode = part.replace(/^```r\n/, "").replace(/```$/, "");
              } else if (part.startsWith("```R\n")) {
                // Markdown format - remove ```R\n at start and ``` at end
                cleanCode = part.replace(/^```R\n/, "").replace(/```$/, "");
              } else if (part.startsWith("```r") && part.endsWith("```")) {
                // Markdown format without newline after r
                cleanCode = part.replace(/^```r/, "").replace(/```$/, "");
              } else if (part.startsWith("```R") && part.endsWith("```")) {
                // Markdown format without newline after R
                cleanCode = part.replace(/^```R/, "").replace(/```$/, "");
              } else {
                // HTML format - extract clean text from nested HTML
                // Create a temporary div to parse HTML and extract text
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = part;
                cleanCode = tempDiv.textContent || tempDiv.innerText || '';
                
                // If that didn't work, try manual removal
                if (!cleanCode || cleanCode.trim() === '') {
                  cleanCode = part.replace(/<code[^>]*>/g, "").replace(/<\/code>/g, "");
                  cleanCode = cleanCode.replace(/<[^>]*>/g, "");
                  cleanCode = cleanCode.replace(/style="[^"]*"/g, "");
                }
              }
              
              // Remove any remaining artifacts like single quotes or language identifiers
              cleanCode = cleanCode.replace(/^['"]?r['"]?\s*/, ""); // Remove 'r', "r", or r at start
              cleanCode = cleanCode.replace(/^\s*['"]?r['"]?\s*/, ""); // Remove with whitespace
              
              // Remove any remaining "R" at the start
              cleanCode = cleanCode.replace(/^R\s*/, "");
              cleanCode = cleanCode.replace(/^r\s*/, "");
              
              // Decode HTML entities
              cleanCode = cleanCode.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&");
              
              codeContent.textContent = cleanCode;
              codeDiv.appendChild(codeContent);
              
              messageDiv.appendChild(codeDiv);
            } else if (part.trim()) {
              // This is regular text - clean up any leftover backticks and add it
              const textDiv = document.createElement("div");
              let cleanText = part;
              
              // Remove any leftover backticks from markdown processing
              cleanText = cleanText.replace(/^``\s*/, ""); // Remove leading backticks
              cleanText = cleanText.replace(/\s*``$/, ""); // Remove trailing backticks
              cleanText = cleanText.replace(/``/g, ""); // Remove any remaining backticks
              
              textDiv.innerHTML = cleanText;
              // Apply markdown formatting to the text part
              processMarkdownFormatting(textDiv);
              messageDiv.appendChild(textDiv);
            }
          }
          
          return;
        }
        
        console.log("DEBUG: No code blocks found, processing markdown");
        // If no code blocks, just process markdown formatting
        processMarkdownFormatting(messageDiv);
      }
      
      function addMessage(content, role) {
        const container = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message " + role + "-message";
        
        if (role === "ai") {
          // More precise code block detection - only for actual R code blocks
          if (content.includes("```r") || content.includes("```R")) {
            const start = content.indexOf("```");
            const end = content.lastIndexOf("```");
            if (start !== -1 && end !== -1 && end > start) {
              const beforeCode = content.substring(0, start);
              const codeBlock = content.substring(start + 3, end);
              const afterCode = content.substring(end + 3);
              
              // Add text before code
              if (beforeCode.trim()) {
                const textDiv = document.createElement("div");
                textDiv.textContent = beforeCode;
                messageDiv.appendChild(textDiv);
              }
              
              // Add code block
              const codeDiv = document.createElement("div");
              codeDiv.className = "code-block";
              
              // Create header with copy button
              const headerDiv = document.createElement("div");
              headerDiv.className = "code-block-header";
              
              const languageLabel = document.createElement("span");
              languageLabel.textContent = "R Code";
              
              // Clean up the code block - remove {r} and other prefixes
              let cleanCode = codeBlock;
              // Remove common prefixes
              if (cleanCode.startsWith("{r}")) {
                cleanCode = cleanCode.substring(3);
              } else if (cleanCode.startsWith("r}")) {
                cleanCode = cleanCode.substring(2);
              } else if (cleanCode.startsWith("r")) {
                cleanCode = cleanCode.substring(1);
              } else if (cleanCode.startsWith("```r")) {
                cleanCode = cleanCode.substring(4);
              } else if (cleanCode.startsWith("```")) {
                cleanCode = cleanCode.substring(3);
              }
              
              // Remove any remaining "R" at the start
              cleanCode = cleanCode.replace(/^R\s*/, "");
              cleanCode = cleanCode.replace(/^r\s*/, "");
              
              // Decode HTML entities
              cleanCode = cleanCode.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&");
              cleanCode = cleanCode.trim();
              
              const copyButton = document.createElement("button");
              copyButton.className = "copy-button";
              copyButton.textContent = "Copy";
              copyButton.onclick = function() {
                copyToClipboard(cleanCode, copyButton);
              };
              
              headerDiv.appendChild(languageLabel);
              headerDiv.appendChild(copyButton);
              codeDiv.appendChild(headerDiv);
              
              codeDiv.textContent = cleanCode;
              
              // Add buttons
              const buttonContainer = document.createElement("div");
              buttonContainer.style.marginTop = "10px";
              
              const insertButton = document.createElement("button");
              insertButton.className = "insert-button";
              insertButton.textContent = "Insert";
              insertButton.onclick = function() {
                insertCode(cleanCode);
              };
              
              const executeButton = document.createElement("button");
              executeButton.className = "insert-button";
              executeButton.style.backgroundColor = "#17a2b8";
              executeButton.textContent = "Execute & Fix";
              executeButton.onclick = function() {
                executeAndFix(cleanCode);
              };
              
              buttonContainer.appendChild(insertButton);
              buttonContainer.appendChild(executeButton);
              
              messageDiv.appendChild(codeDiv);
              messageDiv.appendChild(buttonContainer);
              
              // Add text after code
              if (afterCode.trim()) {
                const textDiv = document.createElement("div");
                let cleanText = afterCode;
                
                // Remove any leftover backticks from markdown processing
                cleanText = cleanText.replace(/^``\s*/, ""); // Remove leading backticks
                cleanText = cleanText.replace(/\s*``$/, ""); // Remove trailing backticks
                cleanText = cleanText.replace(/``/g, ""); // Remove any remaining backticks
                
                textDiv.textContent = cleanText;
                messageDiv.appendChild(textDiv);
              }
            } else {
              messageDiv.innerHTML = content;
              processMarkdownFormatting(messageDiv);
            }
          } else {
            messageDiv.innerHTML = content;
            processMarkdownFormatting(messageDiv);
          }
        } else {
          messageDiv.innerHTML = content;
          processMarkdownFormatting(messageDiv);
        }
        
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }
      
      function insertCode(code) {
        if (!isConnected) {
          alert("Not connected to RStudio");
          return;
        }
        
        // Send insert request via WebSocket
        ws.send(JSON.stringify({
          action: "insert_code",
          code: code
        }));
      }
      
      function executeAndFix(code) {
        if (!isConnected) {
          alert("Not connected to RStudio");
          return;
        }
        
        // Send execute and fix request via WebSocket
        ws.send(JSON.stringify({
          action: "execute_and_fix",
          code: code
        }));
      }
      
      function newConversation() {
        if (!isConnected) {
          alert("Not connected to RStudio");
          return;
        }
        
        // Clear the chat container
        const container = document.getElementById("chat-container");
        container.innerHTML = '<div class="message ai-message">üîÑ New conversation started. Your R workspace context is still available!</div>';
        
        // Send new conversation request to clear history on backend
        ws.send(JSON.stringify({
          action: "new_conversation"
        }));
        
        // Clear the input field
        document.getElementById("user-input").value = "";
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
        
        // Switch back to chat tab if not already there
        const chatTab = document.getElementById("chat-tab");
        if (!chatTab.classList.contains("active")) {
          // Hide all tab contents
          document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
          });
          
          // Remove active class from all tab buttons
          document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // Show chat tab content
          document.getElementById("chat-tab").classList.add("active");
          
          // Add active class to chat button
          document.querySelector('.tab-btn[onclick="switchTab(\'chat\')"]').classList.add('active');
        }
      }
      
      function applyDebugFix(lineNumber, newCode) {
        if (!isConnected) {
          alert("Not connected to RStudio");
          return;
        }
        
        // Send the fix to be applied
        ws.send(JSON.stringify({
          action: "apply_debug_fix",
          line_number: lineNumber,
          new_code: newCode
        }));
        
        addMessage(`‚úÖ Applying fix to line ${lineNumber}...`, "user");
      }
      
      function declineDebugFix() {
        addMessage("‚ùå Fix declined", "user");
      }
      
      // Handle Enter key
      document.getElementById("user-input").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          sendMessage();
        }
      });
      
      // Handle Enter key for access code
      document.getElementById("access-code").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          validateAccess();
        }
      });
      
      // Add password toggle functionality for access code
      document.getElementById('toggleAccessCode').addEventListener('click', function() {
        const accessCodeInput = document.getElementById('access-code');
        const toggleButton = this;
        
        if (accessCodeInput.type === 'password') {
          accessCodeInput.type = 'text';
          toggleButton.textContent = 'Hide';
          toggleButton.title = 'Hide access code';
        } else {
          accessCodeInput.type = 'password';
          toggleButton.textContent = 'Show';
          toggleButton.title = 'Show access code';
        }
      });
      
      // Apply RStudio theme with actual colors
      function applyTheme(isDark, themeName, colors = {}) {
        console.log("Applying theme:", isDark ? "dark" : "light", "Theme:", themeName);
        console.log("RStudio colors:", colors);
        
        const root = document.documentElement;
        
        if (colors && Object.keys(colors).length > 0) {
          // Use actual RStudio colors
          root.style.setProperty('--bg-primary', colors.background || (isDark ? '#1e1e1e' : '#ffffff'));
          root.style.setProperty('--bg-secondary', colors.console_background || (isDark ? '#2d2d2d' : '#f8f9fa'));
          root.style.setProperty('--bg-card', colors.console_background || (isDark ? '#3c3c3c' : '#ffffff'));
          root.style.setProperty('--text-primary', colors.foreground || (isDark ? '#ffffff' : '#2c3e50'));
          root.style.setProperty('--text-secondary', colors.console_foreground || (isDark ? '#cccccc' : '#6c757d'));
          root.style.setProperty('--border-color', isDark ? '#555555' : '#dee2e6');
          root.style.setProperty('--input-bg', colors.console_background || (isDark ? '#2d2d2d' : '#ffffff'));
          root.style.setProperty('--code-bg', colors.background || (isDark ? '#1e1e1e' : '#f8f9fa'));
          root.style.setProperty('--rgent-primary', isDark ? '#ff8c42' : '#ff6b35');
          root.style.setProperty('--rgent-accent', isDark ? '#5dade2' : '#3498db');
        } else {
          // Fallback to basic theme detection
          if (isDark) {
            // Dark theme
            root.style.setProperty('--bg-primary', '#1e1e1e');
            root.style.setProperty('--bg-secondary', '#2d2d2d');
            root.style.setProperty('--bg-card', '#3c3c3c');
            root.style.setProperty('--text-primary', '#ffffff');
            root.style.setProperty('--text-secondary', '#cccccc');
            root.style.setProperty('--border-color', '#555555');
            root.style.setProperty('--input-bg', '#2d2d2d');
            root.style.setProperty('--code-bg', '#1e1e1e');
            root.style.setProperty('--rgent-primary', '#ff8c42');
            root.style.setProperty('--rgent-accent', '#5dade2');
          } else {
            // Light theme
            root.style.setProperty('--bg-primary', '#ffffff');
            root.style.setProperty('--bg-secondary', '#f8f9fa');
            root.style.setProperty('--bg-card', '#ffffff');
            root.style.setProperty('--text-primary', '#2c3e50');
            root.style.setProperty('--text-secondary', '#6c757d');
            root.style.setProperty('--border-color', '#dee2e6');
            root.style.setProperty('--input-bg', '#ffffff');
            root.style.setProperty('--code-bg', '#f8f9fa');
            root.style.setProperty('--rgent-primary', '#ff6b35');
            root.style.setProperty('--rgent-accent', '#3498db');
          }
        }
        
        // Apply theme to body
        document.body.classList.toggle('dark-theme', isDark);
        document.body.classList.toggle('light-theme', !isDark);
      }
      
      // Early theme detection on page load
      function detectInitialTheme() {
        // Check if user prefers dark mode
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        console.log("Initial theme detection:", prefersDark ? "dark" : "light");
        
        // Apply basic theme immediately
        applyTheme(prefersDark, "System Theme");
      }
      
      // Call early theme detection when page loads
      document.addEventListener('DOMContentLoaded', detectInitialTheme);
      
      // Analyze Last Plot functionality
      function analyzeLastPlot() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          alert("Not connected to RStudio");
          return;
        }
        
        // Add initial message showing we're starting analysis
        addMessage("**Starting Plot Analysis:**\n\nStep 1: Scanning R history for plot commands:", "ai");
        
        // Send the analyze request
        ws.send(JSON.stringify({
          action: "analyze_last_plot"
        }));
      }
      
      // Special function for plot analysis messages
      function addPlotAnalysisMessage(content) {
        const container = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message ai-message";
        
        // Set the content and process it properly
        messageDiv.innerHTML = content;
        
        // Process markdown formatting first
        processMarkdownFormatting(messageDiv);
        
        // Then process for code blocks with only Copy/Insert buttons
        processPlotAnalysisContent(messageDiv);
        
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }
      
      // Special processing for plot analysis content (no Execute & Fix)
      function processPlotAnalysisContent(messageDiv) {
        const content = messageDiv.innerHTML;
        
        // More precise code block detection - only create blocks for actual code blocks
        const hasMarkdownCodeBlock = /```[rR]\n[\s\S]*?```/.test(content) || /```[rR][\s\S]*?```/.test(content) || /```R\n[\s\S]*?```/.test(content) || /```R[\s\S]*?```/.test(content);
        
        // Only detect HTML code blocks that are actual blocks, not inline code
        const hasHTMLCodeBlock = /<code[^>]*>[\s\S]*?<\/code>/.test(content) && 
                                !content.includes('<code style="background-color: var(--code-bg); padding: 2px 4px; border-radius: 3px;">');
        
        if (hasMarkdownCodeBlock || hasHTMLCodeBlock) {
          // Clear the message div
          messageDiv.innerHTML = "";
          
          // Try to split by markdown code blocks first
          let parts = content.split(/(```[rR]\n[\s\S]*?```)/g);
          
          // If no markdown blocks found, try HTML code blocks
          if (parts.length === 1) {
            parts = content.split(/(<code[^>]*>[\s\S]*?<\/code>)/g);
          }
          
          for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            
            if ((part.startsWith("```r\n") && part.endsWith("```")) || 
                (part.startsWith("```R\n") && part.endsWith("```")) ||
                (part.includes("<code") && part.includes("</code>"))) {
              // This is a code block - style it with only Copy/Insert buttons
              const codeDiv = document.createElement("div");
              codeDiv.className = "code-block";
              
              // Create header with copy button
              const headerDiv = document.createElement("div");
              headerDiv.className = "code-block-header";
              
              const languageLabel = document.createElement("span");
              languageLabel.textContent = "R Code";
              
              const actionsDiv = document.createElement("div");
              actionsDiv.className = "code-block-actions";
              
              const copyButton = document.createElement("button");
              copyButton.className = "copy-button";
              copyButton.textContent = "Copy";
              copyButton.onclick = function() {
                copyToClipboard(cleanCode, copyButton);
              };
              
              const insertButton = document.createElement("button");
              insertButton.className = "copy-button";
              insertButton.textContent = "Insert at Cursor";
              insertButton.onclick = function() {
                insertCode(cleanCode);
              };
              
              headerDiv.appendChild(languageLabel);
              actionsDiv.appendChild(copyButton);
              actionsDiv.appendChild(insertButton);
              headerDiv.appendChild(actionsDiv);
              codeDiv.appendChild(headerDiv);
              
              // Create code content div - extract just the code
              const codeContent = document.createElement("div");
              let cleanCode;
              if (part.startsWith("```r\n")) {
                // Markdown format - remove ```r\n at start and ``` at end
                cleanCode = part.replace(/^```r\n/, "").replace(/```$/, "");
              } else if (part.startsWith("```R\n")) {
                // Markdown format - remove ```R\n at start and ``` at end
                cleanCode = part.replace(/^```R\n/, "").replace(/```$/, "");
              } else if (part.startsWith("```r") && part.endsWith("```")) {
                // Markdown format without newline after r
                cleanCode = part.replace(/^```r/, "").replace(/```$/, "");
              } else if (part.startsWith("```R") && part.endsWith("```")) {
                // Markdown format without newline after R
                cleanCode = part.replace(/^```R/, "").replace(/```$/, "");
              } else {
                // HTML format - extract clean text from nested HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = part;
                cleanCode = tempDiv.textContent || tempDiv.innerText || '';
                
                // If that didn't work, try manual removal
                if (!cleanCode || cleanCode.trim() === '') {
                  cleanCode = part.replace(/<code[^>]*>/g, "").replace(/<\/code>/g, "");
                  cleanCode = cleanCode.replace(/<[^>]*>/g, "");
                  cleanCode = cleanCode.replace(/style="[^"]*"/g, "");
                }
              }
              
              // Remove any remaining artifacts
              cleanCode = cleanCode.replace(/^['"]?r['"]?\s*/, "");
              cleanCode = cleanCode.replace(/^\s*['"]?r['"]?\s*/, "");
              cleanCode = cleanCode.replace(/^R\s*/, "");
              cleanCode = cleanCode.replace(/^r\s*/, "");
              cleanCode = cleanCode.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&");
              
              codeContent.textContent = cleanCode;
              codeDiv.appendChild(codeContent);
              
              messageDiv.appendChild(codeDiv);
            } else if (part.trim()) {
              // This is regular text - clean up any leftover backticks and add it
              const textDiv = document.createElement("div");
              let cleanText = part;
              
              // Remove any leftover backticks from markdown processing
              cleanText = cleanText.replace(/^``\s*/, "");
              cleanText = cleanText.replace(/\s*``$/, "");
              cleanText = cleanText.replace(/``/g, "");
              
              textDiv.innerHTML = cleanText;
              processMarkdownFormatting(textDiv);
              messageDiv.appendChild(textDiv);
            }
          }
        } else {
          // If no code blocks, just process markdown formatting
          processMarkdownFormatting(messageDiv);
        }
      }
    </script>
</body>
</html> 