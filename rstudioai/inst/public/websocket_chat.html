<!DOCTYPE html>
<html>
<head>
    <title>RStudio AI Chat</title>
    <style>
      body { 
        font-family: Arial, sans-serif; 
        margin: 20px; 
        background-color: #f5f5f5;
      }
      
      /* Tab Navigation */
      .tab-navigation {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      
      .tab-btn {
        padding: 8px 16px;
        background-color: #e9ecef;
        color: #495057;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      
      .tab-btn.active {
        background-color: #007acc;
        color: white;
      }
      
      .tab-btn:hover {
        background-color: #0056b3;
        color: white;
      }
      
      .tab-content {
        display: none;
      }
      
      .tab-content.active {
        display: block;
      }
      
      .chat-container { 
        height: 500px; 
        overflow-y: auto; 
        border: 1px solid #ddd; 
        border-radius: 8px; 
        padding: 15px; 
        margin-bottom: 15px; 
        background-color: #f9f9f9; 
      }
      .message { 
        margin-bottom: 10px; 
        padding: 8px 12px; 
        border-radius: 8px; 
        max-width: 80%; 
      }
      .user-message { 
        background-color: #007acc; 
        color: white; 
        margin-left: auto; 
      }
      .ai-message { 
        background-color: #f1f1f1; 
        color: #333; 
      }
      .code-block { 
        background-color: #f8f8f8; 
        border: 1px solid #ddd; 
        border-radius: 4px; 
        padding: 10px; 
        margin: 10px 0; 
        font-family: monospace;
        white-space: pre-wrap;
      }
      .insert-button { 
        background-color: #28a745; 
        color: white; 
        border: none; 
        padding: 5px 10px; 
        border-radius: 4px; 
        cursor: pointer; 
        margin: 5px; 
      }
      .insert-button:hover { 
        background-color: #218838; 
      }
      .input-container {
        display: flex;
        gap: 10px;
      }
      input[type="text"] { 
        flex: 1;
        padding: 8px; 
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button { 
        padding: 8px 16px; 
        background-color: #007acc; 
        color: white; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
      }
      button:hover {
        background-color: #0056b3;
      }
      .status {
        color: #666;
        font-size: 12px;
        margin-top: 10px;
      }
      
      /* Usage Tab Styles */
      .usage-container {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
      }
      
      .stats-section {
        margin-bottom: 30px;
      }
      
      .stats-section h4 {
        margin-bottom: 15px;
        color: #333;
        font-size: 16px;
      }
      
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      
      .stat-card {
        background: white;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
      }
      
      .stat-card h4 {
        margin-bottom: 10px;
        color: #333;
        font-size: 14px;
      }
      
      .stat-card div {
        font-size: 24px;
        font-weight: bold;
        color: #007acc;
        margin-bottom: 5px;
      }
      
      .stat-card small {
        color: #666;
        font-size: 12px;
      }
      
      .access-section {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        text-align: center;
      }
      
      .form-group {
        margin-bottom: 15px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: bold;
      }
      
      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .access-help {
        margin-top: 10px;
        font-size: 12px;
        color: #666;
      }
      
      .access-help a {
        color: #007acc;
        text-decoration: none;
      }
      
      .access-help a:hover {
        text-decoration: underline;
      }
    </style>
</head>
<body>
    <h2>RStudio AI Chat</h2>
    
    <!-- Access Code Section -->
    <div id="access-section" class="access-section">
      <div class="form-group">
        <label for="access-code">Access Code:</label>
        <input type="text" id="access-code" placeholder="Enter your access code">
      </div>
      <button onclick="validateAccess()">Validate Access</button>
      <div id="access-status"></div>
      <div class="access-help">
        <p>Forgot your access code? <a href="https://rgentai.com/signin.html" target="_blank">Click here</a></p>
      </div>
    </div>
    
    <!-- Main Interface with Tabs -->
    <div id="main-interface" style="display: none;">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('chat')">ðŸ’¬ Chat</button>
        <button class="tab-btn" onclick="switchTab('usage')">ðŸ“Š Usage</button>
      </div>
      
      <!-- Chat Tab -->
      <div id="chat-tab" class="tab-content active">
        <div id="chat-container" class="chat-container">
          <div class="message ai-message">Connecting to RStudio...</div>
        </div>
        <div class="input-container">
          <input type="text" id="user-input" placeholder="Type your question here..." disabled>
          <button onclick="sendMessage()" id="send-button" disabled>Send</button>
        </div>
        <div class="status" id="status">Connecting...</div>
      </div>
      
      <!-- Usage Tab -->
      <div id="usage-tab" class="tab-content">
        <div class="usage-container">
          <div class="section">
            <h3>ðŸ“Š Usage Statistics</h3>
            
            <!-- Overall Stats -->
            <div class="stats-section">
              <h4>Overall Usage</h4>
              <div class="stats">
                <div class="stat-card">
                  <h4>Total Input Tokens</h4>
                  <div id="total-input-tokens">-</div>
                  <small>Rate: $0.0013/1K</small>
                </div>
                <div class="stat-card">
                  <h4>Total Output Tokens</h4>
                  <div id="total-output-tokens">-</div>
                  <small>Rate: $0.00533/1K</small>
                </div>
                <div class="stat-card">
                  <h4>Total Cost</h4>
                  <div id="total-cost-overall">-</div>
                  <small>All time</small>
                </div>
              </div>
            </div>

            <!-- Today's Stats -->
            <div class="stats-section">
              <h4>Today's Usage</h4>
              <div class="stats">
                <div class="stat-card">
                  <h4>Input Tokens</h4>
                  <div id="today-input-tokens">-</div>
                  <small>Rate: $0.0013/1K</small>
                </div>
                <div class="stat-card">
                  <h4>Output Tokens</h4>
                  <div id="today-output-tokens">-</div>
                  <small>Rate: $0.00533/1K</small>
                </div>
                <div class="stat-card">
                  <h4>Total Cost</h4>
                  <div id="today-total-cost">-</div>
                  <small>Today's usage</small>
                </div>
              </div>
            </div>

            <div id="usage-status" class="status" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      let ws = null;
      let isConnected = false;
      let isAccessValid = false;
      let accessCode = '';
      
      // Access validation
      async function validateAccess() {
        const code = document.getElementById('access-code').value.trim();
        if (!code) {
          showAccessStatus('Please enter an access code', 'error');
          return;
        }
        
        showAccessStatus('Validating access...', 'info');
        
        try {
          const response = await fetch('https://rgent.onrender.com/validate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ access_code: code })
          });
          
          const data = await response.json();
          
          if (response.ok && data.valid) {
            isAccessValid = true;
            accessCode = code;
            showAccessStatus('Access validated successfully!', 'success');
            document.getElementById('access-section').style.display = 'none';
            document.getElementById('main-interface').style.display = 'block';
            connectWebSocket();
          } else {
            showAccessStatus('Invalid access code', 'error');
          }
        } catch (error) {
          console.error('Validation error:', error);
          showAccessStatus('Failed to validate access code', 'error');
        }
      }
      
      function showAccessStatus(message, type) {
        const statusDiv = document.getElementById('access-status');
        statusDiv.textContent = message;
        statusDiv.className = 'status ' + type;
        statusDiv.style.display = 'block';
      }
      
      // Tab switching
      function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName + '-tab').classList.add('active');
        
        // Add active class to clicked button
        event.target.classList.add('active');
        
        // Load stats if switching to usage tab
        if (tabName === 'usage') {
          loadStats();
        }
      }
      
      // Load usage statistics
      async function loadStats() {
        if (!isAccessValid) return;

        try {
          const response = await fetch(`https://rgent.onrender.com/usage?access_code=${accessCode}`);
          const data = await response.json();

          console.log('Stats response:', data);

          if (response.ok) {
            // Overall stats
            const totalInputTokens = data.total_input_tokens || 0;
            const totalOutputTokens = data.total_output_tokens || 0;
            const totalCostOverall = data.total_cost || 0;
            
            // Today's stats
            const todayInputTokens = data.today_input_tokens || 0;
            const todayOutputTokens = data.today_output_tokens || 0;
            const todayTotalCost = data.today_cost || 0;
            
            console.log('Token stats:', { 
              totalInputTokens, totalOutputTokens, totalCostOverall,
              todayInputTokens, todayOutputTokens, todayTotalCost 
            });
            
            // Update overall stats
            document.getElementById('total-input-tokens').textContent = totalInputTokens;
            document.getElementById('total-output-tokens').textContent = totalOutputTokens;
            document.getElementById('total-cost-overall').textContent = `$${totalCostOverall.toFixed(4)}`;
            
            // Update today's stats
            document.getElementById('today-input-tokens').textContent = todayInputTokens;
            document.getElementById('today-output-tokens').textContent = todayOutputTokens;
            document.getElementById('today-total-cost').textContent = `$${todayTotalCost.toFixed(4)}`;
            
            // Show success status
            const statusDiv = document.getElementById('usage-status');
            statusDiv.className = 'status success';
            statusDiv.textContent = 'Stats updated successfully';
            statusDiv.style.display = 'block';
            setTimeout(() => {
              statusDiv.style.display = 'none';
            }, 3000);
          }
        } catch (error) {
          console.error('Failed to load stats:', error);
          const statusDiv = document.getElementById('usage-status');
          statusDiv.className = 'status error';
          statusDiv.textContent = 'Failed to load stats';
          statusDiv.style.display = 'block';
        }
      }
      
      // Connect to WebSocket
      function connectWebSocket() {
        ws = new WebSocket("ws://127.0.0.1:8888");
        
        ws.onopen = function() {
          console.log("WebSocket connected");
          isConnected = true;
          document.getElementById("status").textContent = "Connected to RStudio";
          document.getElementById("user-input").disabled = false;
          document.getElementById("send-button").disabled = false;
          addMessage("Connected! Ask me anything about your R code.", "ai");
        };
        
        ws.onmessage = function(event) {
          const data = JSON.parse(event.data);
          console.log("Received:", data);
          
          switch(data.action) {
            case "ai_response":
              addMessage(data.message, "ai");
              break;
            case "inserted":
              addMessage("Code inserted successfully!", "ai");
              break;
            case "executed":
              if (data.status === "success") {
                addMessage("Code executed successfully! Output: " + (data.output || "No output"), "ai");
              } else {
                addMessage("Code execution failed: " + data.error, "ai");
              }
              break;
            case "execute_and_fix":
              if (data.status === "success") {
                addMessage("Code executed successfully! Output: " + (data.output || "No output"), "ai");
              } else if (data.status === "error_fixed") {
                addMessage("Code failed but AI provided a fix:\n\nOriginal error: " + data.original_error + "\n\nFixed code:\n```r\n" + data.fixed_code + "\n```", "ai");
              } else {
                addMessage("Code execution failed: " + data.error, "ai");
              }
              break;
            case "error":
              addMessage("Error: " + data.message, "ai");
              break;
          }
        };
        
        ws.onclose = function() {
          console.log("WebSocket disconnected");
          isConnected = false;
          document.getElementById("status").textContent = "Disconnected";
          document.getElementById("user-input").disabled = true;
          document.getElementById("send-button").disabled = true;
          addMessage("Connection lost. Please restart the addin.", "ai");
        };
        
        ws.onerror = function(error) {
          console.error("WebSocket error:", error);
          document.getElementById("status").textContent = "Connection error";
          addMessage("Failed to connect to RStudio. Please check if the server is running.", "ai");
        };
      }
      
      function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value.trim();
        if (!message || !isConnected) return;
        
        // Add user message
        addMessage(message, "user");
        input.value = "";
        
        // Send to R via WebSocket
        ws.send(JSON.stringify({
          action: "chat_with_ai",
          message: message
        }));
      }
      
      function addMessage(content, role) {
        const container = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message " + role + "-message";
        
        if (role === "ai") {
          // Simple code block detection
          if (content.includes("```")) {
            const start = content.indexOf("```");
            const end = content.lastIndexOf("```");
            if (start !== -1 && end !== -1 && end > start) {
              const beforeCode = content.substring(0, start);
              const codeBlock = content.substring(start + 3, end);
              const afterCode = content.substring(end + 3);
              
              // Add text before code
              if (beforeCode.trim()) {
                const textDiv = document.createElement("div");
                textDiv.textContent = beforeCode;
                messageDiv.appendChild(textDiv);
              }
              
              // Add code block
              const codeDiv = document.createElement("div");
              codeDiv.className = "code-block";
              // Clean up the code block - remove {r} and other prefixes
              let cleanCode = codeBlock;
              // Remove common prefixes
              if (cleanCode.startsWith("{r}")) {
                cleanCode = cleanCode.substring(3);
              } else if (cleanCode.startsWith("r}")) {
                cleanCode = cleanCode.substring(2);
              } else if (cleanCode.startsWith("r")) {
                cleanCode = cleanCode.substring(1);
              } else if (cleanCode.startsWith("```r")) {
                cleanCode = cleanCode.substring(4);
              } else if (cleanCode.startsWith("```")) {
                cleanCode = cleanCode.substring(3);
              }
              cleanCode = cleanCode.trim();
              codeDiv.textContent = cleanCode;
              
              // Add buttons
              const buttonContainer = document.createElement("div");
              buttonContainer.style.marginTop = "10px";
              
              const insertButton = document.createElement("button");
              insertButton.className = "insert-button";
              insertButton.textContent = "Insert";
              insertButton.onclick = function() {
                insertCode(cleanCode);
              };
              
              const executeButton = document.createElement("button");
              executeButton.className = "insert-button";
              executeButton.style.backgroundColor = "#17a2b8";
              executeButton.textContent = "Execute & Fix";
              executeButton.onclick = function() {
                executeAndFix(cleanCode);
              };
              
              buttonContainer.appendChild(insertButton);
              buttonContainer.appendChild(executeButton);
              
              messageDiv.appendChild(codeDiv);
              messageDiv.appendChild(buttonContainer);
              
              // Add text after code
              if (afterCode.trim()) {
                const textDiv = document.createElement("div");
                textDiv.textContent = afterCode;
                messageDiv.appendChild(textDiv);
              }
            } else {
              messageDiv.textContent = content;
            }
          } else {
            messageDiv.textContent = content;
          }
        } else {
          messageDiv.textContent = content;
        }
        
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }
      
      function insertCode(code) {
        if (!isConnected) {
          alert("Not connected to RStudio");
          return;
        }
        
        // Send insert request via WebSocket
        ws.send(JSON.stringify({
          action: "insert_code",
          code: code
        }));
      }
      
      function executeAndFix(code) {
        if (!isConnected) {
          alert("Not connected to RStudio");
          return;
        }
        
        // Send execute and fix request via WebSocket
        ws.send(JSON.stringify({
          action: "execute_and_fix",
          code: code
        }));
      }
      
      // Handle Enter key
      document.getElementById("user-input").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          sendMessage();
        }
      });
      
      // Handle Enter key for access code
      document.getElementById("access-code").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          validateAccess();
        }
      });
    </script>
</body>
</html> 